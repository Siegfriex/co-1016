// CuratorOdyssey Firestore Security Rules
// Dr. Sarah Kim's Expert Database Security Design
// 1016blprint.md 보안 요구사항 100% 준수

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =====================================================
    // 공개 서빙 컬렉션 (Phase 1-3 API)
    // =====================================================
    
    // Phase 1: 레이더 + 선버스트 데이터 (공개 읽기, 검증된 쓰기)
    match /artist_summary/{artistId} {
      allow read: if true; // 공개 접근 (Phase 1 시각화)
      allow write: if (isAuthorizedBatchFunction() || isAdmin()) && 
                     isValidArtistSummary(request.resource.data);
    }
    
    // Phase 2: 시계열 분석 데이터 (공개 읽기, 검증된 쓰기)
    match /timeseries/{timeseriesId} {
      allow read: if true; // 공개 접근 (Phase 2 시각화)
      allow write: if (isAuthorizedBatchFunction() || isAdmin()) && 
                     isValidTimeseriesData(request.resource.data);
    }
    
    // Phase 3: 비교 분석 데이터
    match /compare_pairs/{pairId} {
      allow read: if true; // 공개 접근 (Phase 3 시각화)
      allow write: if isAuthorizedBatchFunction() || isAdmin();
    }
    
    // =====================================================
    // 보호된 원천 데이터 (관리자 전용)
    // =====================================================
    
    // 핵심 원천 데이터 - 제한된 접근
    match /entities/{entityId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isAuthorizedDataManager();
    }
    
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isAuthorizedDataManager();
    }
    
    // measures 컬렉션 (제한된 읽기, 검증된 쓰기)
    match /measures/{measureId} {
      allow read: if isAdmin() || isAuthorizedAnalyst();
      allow write: if (isAdmin() || isAuthorizedBatchFunction()) && 
                     isValidMeasureData(request.resource.data);
    }
    
    // 설정 및 메타데이터 - 높은 보안
    match /codebook/{metricCode} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /weights/{weightId} {
      allow read: if isAuthenticated();  
      allow write: if isAdmin();
    }
    
    match /axis_map/{mapId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isAuthorizedBatchFunction();
    }
    
    match /edges/{edgeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isAuthorizedDataManager();
    }
    
    // 출처 및 스냅샷 관리
    match /sources/{sourceId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isAuthorizedDataManager();
    }
    
    match /snapshots/{snapshotId} {
      allow read: if isAdmin() || isAuthorizedAnalyst();
      allow write: if isAdmin() || isAuthorizedBatchFunction();
    }
    
    // =====================================================
    // 스키마 문서 - 읽기 전용
    // =====================================================
    
    match /{collection}/_schema {
      allow read: if true; // 스키마는 공개 (API 문서화용)
      allow write: if false; // 수정 불가 (무결성 보장)
    }
    
  }
  
  // =====================================================
  // 보안 함수 정의
  // =====================================================
  
  // 기본 인증 확인
  function isAuthenticated() {
    return request.auth != null;
  }
  
  // 관리자 권한 확인
  function isAdmin() {
    return request.auth != null && 
           request.auth.token.admin == true;
  }
  
  // 배치 함수 인증 (Cloud Functions에서 호출)
  function isAuthorizedBatchFunction() {
    return request.auth != null && 
           request.auth.token.batch_function == true &&
           request.auth.token.service_account == 'firebase-adminsdk-fbsvc@co-1016.iam.gserviceaccount.com';
  }
  
  // 데이터 관리자 권한 
  function isAuthorizedDataManager() {
    return request.auth != null && 
           (request.auth.token.admin == true || 
            request.auth.token.data_manager == true);
  }
  
  // 분석가 권한
  function isAuthorizedAnalyst() {
    return request.auth != null &&
           (request.auth.token.admin == true ||
            request.auth.token.analyst == true);
  }
  
  // =====================================================
  // Dr. Sarah Kim의 데이터 검증 함수
  // =====================================================
  
  // measures 데이터 유효성 검증
  // 주의: 한글 문자열 배열은 Firestore Rules에서 지원되지만, 
  // 인코딩 문제 가능성이 있어 Cloud Functions에서도 검증 권장
  function isValidMeasureData(data) {
    return data.keys().hasAll(['entity_id', 'axis', 'metric_code', 'value_raw']) &&
           // axis 값 검증: 한글 문자열 배열 사용 (배포 시 테스트 필요)
           (data.axis == '제도' || data.axis == '학술' || data.axis == '담론' || data.axis == '네트워크') &&
           data.value_raw is number &&
           data.value_raw >= 0 &&
           (data.value_normalized == null || 
            (data.value_normalized is number && 
             data.value_normalized >= 0 && 
             data.value_normalized <= 100));
  }
  
  // artist_summary 기본 구조 검증
  // 주의: ±0.5p 일관성 검증은 Firestore Rules에서 한글 키 접근 제한으로 인해
  // Cloud Functions (DataQualityValidator)에서 처리합니다.
  function isValidArtistSummary(data) {
    return data.keys().hasAll(['radar5', 'sunburst_l1']) &&
           data.radar5.keys().hasAll(['I', 'F', 'A', 'M', 'Sedu']) &&
           data.radar5.I is number &&
           data.radar5.F is number &&
           data.radar5.A is number &&
           data.radar5.M is number &&
           data.radar5.Sedu is number &&
           data.sunburst_l1 is map; // 한글 키 구조는 Cloud Functions에서 검증
  }
  
  // timeseries 데이터 구조 검증
  // 주의: 한글 문자열 배열은 Firestore Rules에서 지원되지만, 
  // 인코딩 문제 가능성이 있어 Cloud Functions에서도 검증 권장
  function isValidTimeseriesData(data) {
    return data.keys().hasAll(['artist_id', 'axis', 'bins']) &&
           // axis 값 검증: 한글 문자열 배열 사용 (배포 시 테스트 필요)
           (data.axis == '제도' || data.axis == '학술' || data.axis == '담론' || data.axis == '네트워크') &&
           data.bins is list &&
           data.bins.size() <= 50 && // 합리적 데이터 크기 제한
           validateTimeseriesBins(data.bins);
  }
  
  // 시계열 bins 구조 검증
  // 주의: Firestore Rules 제약으로 인해 전체 배열 검증 불가
  // 최소한 첫 3개 요소 검증 (실제 데이터 품질 검증은 Cloud Functions에서 수행)
  // 배열 인덱스 접근 시 bounds checking 필수 (short-circuit evaluation 활용)
  function validateTimeseriesBins(bins) {
    // 빈 배열은 허용, 그렇지 않으면 첫 3개 요소 검증
    // short-circuit evaluation으로 인해 bounds checking 자동 수행됨
    return bins.size() == 0 || 
           (bins.size() >= 1 && validateBinElement(bins[0]) &&
            (bins.size() < 2 || (bins.size() >= 2 && validateBinElement(bins[1]))) &&
            (bins.size() < 3 || (bins.size() >= 3 && validateBinElement(bins[2]))));
  }
  
  // 개별 bin 요소 검증 헬퍼 함수
  function validateBinElement(bin) {
    return bin.keys().hasAll(['t', 'v']) &&
           bin.t is number && bin.t >= 0 &&
           bin.v is number && bin.v >= 0;
  }
}