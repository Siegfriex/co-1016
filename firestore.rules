// CuratorOdyssey Firestore Security Rules
// Dr. Sarah Kim's Expert Database Security Design
// 1016blprint.md ë³´ì•ˆ ìš”êµ¬ì‚¬í•­ 100% ì¤€ìˆ˜

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =====================================================
    // ðŸ“Š ê³µê°œ ì„œë¹™ ì»¬ë ‰ì…˜ (Phase 1-3 API)
    // =====================================================
    
    // Phase 1: ë ˆì´ë” + ì„ ë²„ìŠ¤íŠ¸ ë°ì´í„°
    match /artist_summary/{artistId} {
      allow read: if true; // ê³µê°œ ì ‘ê·¼ (Phase 1 ì‹œê°í™”)
      allow write: if isAuthorizedBatchFunction() || isAdmin();
    }
    
    // Phase 2: ì‹œê³„ì—´ ë¶„ì„ ë°ì´í„°
    match /timeseries/{timeseriesId} {
      allow read: if true; // ê³µê°œ ì ‘ê·¼ (Phase 2 ì‹œê°í™”)
      allow write: if isAuthorizedBatchFunction() || isAdmin();
    }
    
    // Phase 3: ë¹„êµ ë¶„ì„ ë°ì´í„°
    match /compare_pairs/{pairId} {
      allow read: if true; // ê³µê°œ ì ‘ê·¼ (Phase 3 ì‹œê°í™”)
      allow write: if isAuthorizedBatchFunction() || isAdmin();
    }
    
    // =====================================================
    // ðŸ”’ ë³´í˜¸ëœ ì›ì²œ ë°ì´í„° (ê´€ë¦¬ìž ì „ìš©)
    // =====================================================
    
    // í•µì‹¬ ì›ì²œ ë°ì´í„° - ì œí•œëœ ì ‘ê·¼
    match /entities/{entityId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isAuthorizedDataManager();
    }
    
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isAuthorizedDataManager();
    }
    
    match /measures/{measureId} {
      allow read: if isAdmin() || isAuthorizedAnalyst();
      allow write: if isAdmin() || isAuthorizedBatchFunction();
    }
    
    // ì„¤ì • ë° ë©”íƒ€ë°ì´í„° - ë†’ì€ ë³´ì•ˆ
    match /codebook/{metricCode} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /weights/{weightId} {
      allow read: if isAuthenticated();  
      allow write: if isAdmin();
    }
    
    match /axis_map/{mapId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isAuthorizedBatchFunction();
    }
    
    match /edges/{edgeId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isAuthorizedDataManager();
    }
    
    // ì¶œì²˜ ë° ìŠ¤ëƒ…ìƒ· ê´€ë¦¬
    match /sources/{sourceId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isAuthorizedDataManager();
    }
    
    match /snapshots/{snapshotId} {
      allow read: if isAdmin() || isAuthorizedAnalyst();
      allow write: if isAdmin() || isAuthorizedBatchFunction();
    }
    
    // =====================================================
    // ðŸ”§ ìŠ¤í‚¤ë§ˆ ë¬¸ì„œ - ì½ê¸° ì „ìš©
    // =====================================================
    
    match /{collection}/_schema {
      allow read: if true; // ìŠ¤í‚¤ë§ˆëŠ” ê³µê°œ (API ë¬¸ì„œí™”ìš©)
      allow write: if false; // ìˆ˜ì • ë¶ˆê°€ (ë¬´ê²°ì„± ë³´ìž¥)
    }
    
    // =====================================================
    // ðŸŽ¯ Dr. Sarah Kimì˜ ë°ì´í„° í’ˆì§ˆ ë³´ì¦ ê·œì¹™
    // =====================================================
    
    // measures ì»¬ë ‰ì…˜ ë°ì´í„° ê²€ì¦
    match /measures/{measureId} {
      allow write: if isValidMeasureData(request.resource.data);
    }
    
    // artist_summary ì¼ê´€ì„± ê²€ì¦
    match /artist_summary/{artistId} {
      allow write: if isValidArtistSummary(request.resource.data);
    }
    
    // timeseries ë°ì´í„° í’ˆì§ˆ ê²€ì¦
    match /timeseries/{timeseriesId} {
      allow write: if isValidTimeseriesData(request.resource.data);
    }
  }
  
  // =====================================================
  // ðŸ›¡ï¸ ë³´ì•ˆ í•¨ìˆ˜ ì •ì˜
  // =====================================================
  
  // ê¸°ë³¸ ì¸ì¦ í™•ì¸
  function isAuthenticated() {
    return request.auth != null;
  }
  
  // ê´€ë¦¬ìž ê¶Œí•œ í™•ì¸
  function isAdmin() {
    return request.auth != null && 
           request.auth.token.admin == true;
  }
  
  // ë°°ì¹˜ í•¨ìˆ˜ ì¸ì¦ (Cloud Functionsì—ì„œ í˜¸ì¶œ)
  function isAuthorizedBatchFunction() {
    return request.auth != null && 
           request.auth.token.batch_function == true &&
           request.auth.token.service_account == 'firebase-adminsdk-fbsvc@co-1016.iam.gserviceaccount.com';
  }
  
  // ë°ì´í„° ê´€ë¦¬ìž ê¶Œí•œ 
  function isAuthorizedDataManager() {
    return request.auth != null && 
           (request.auth.token.admin == true || 
            request.auth.token.data_manager == true);
  }
  
  // ë¶„ì„ê°€ ê¶Œí•œ
  function isAuthorizedAnalyst() {
    return request.auth != null &&
           (request.auth.token.admin == true ||
            request.auth.token.analyst == true);
  }
  
  // =====================================================
  // ðŸ”¬ Dr. Sarah Kimì˜ ë°ì´í„° ê²€ì¦ í•¨ìˆ˜
  // =====================================================
  
  // measures ë°ì´í„° ìœ íš¨ì„± ê²€ì¦
  function isValidMeasureData(data) {
    return data.keys().hasAll(['entity_id', 'axis', 'metric_code', 'value_raw']) &&
           data.axis in ['ì œë„', 'í•™ìˆ ', 'ë‹´ë¡ ', 'ë„¤íŠ¸ì›Œí¬'] &&
           data.value_raw is number &&
           data.value_raw >= 0 &&
           (data.value_normalized == null || 
            (data.value_normalized is number && 
             data.value_normalized >= 0 && 
             data.value_normalized <= 100));
  }
  
  // artist_summary Â±0.5p ì¼ê´€ì„± ê²€ì¦ (1016blprint.md í•µì‹¬)
  function isValidArtistSummary(data) {
    return data.keys().hasAll(['radar5', 'sunburst_l1']) &&
           validateRadarSunburstConsistency(data.radar5, data.sunburst_l1);
  }
  
  // Â±0.5p ì¼ê´€ì„± ê²€ì¦ ë¡œì§
  function validateRadarSunburstConsistency(radar5, sunburst_l1) {
    let radarSum = radar5.I + radar5.F + radar5.A + radar5.M + radar5.Sedu;
    let sunburstSum = sunburst_l1.ì œë„ + sunburst_l1.í•™ìˆ  + sunburst_l1.ë‹´ë¡  + sunburst_l1.ë„¤íŠ¸ì›Œí¬;
    let difference = math.abs(radarSum - sunburstSum);
    
    return difference <= 0.5; // 1016blprint.md ëª…ì„¸ í—ˆìš© ì˜¤ì°¨
  }
  
  // timeseries ë°ì´í„° êµ¬ì¡° ê²€ì¦
  function isValidTimeseriesData(data) {
    return data.keys().hasAll(['artist_id', 'axis', 'bins']) &&
           data.axis in ['ì œë„', 'í•™ìˆ ', 'ë‹´ë¡ ', 'ë„¤íŠ¸ì›Œí¬'] &&
           data.bins is list &&
           data.bins.size() <= 50 && // í•©ë¦¬ì  ë°ì´í„° í¬ê¸° ì œí•œ
           validateTimeseriesBins(data.bins);
  }
  
  // ì‹œê³„ì—´ bins êµ¬ì¡° ê²€ì¦
  function validateTimeseriesBins(bins) {
    return bins.size() == 0 || 
           (bins[0].keys().hasAll(['t', 'v']) &&
            bins[0].t is number && bins[0].t >= 0 &&
            bins[0].v is number && bins[0].v >= 0);
  }
}